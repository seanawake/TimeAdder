<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb" />
  <title>Time Adder (AM/PM)</title>

  <!-- PWA hooks (manifest + iOS icon) -->
  <link rel="manifest" href="./manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <!-- UI libs -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root { --bg:#f4f6f9; --fg:#1f2937; --muted:#6b7280; --accent:#2563eb; --card:#ffffff; }
    html,body{min-height:100%;height:100%;margin:0;font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--fg);-webkit-text-size-adjust:100%;text-size-adjust:100%}
    body{display:grid;place-items:center;padding:12px}

    .app{width:min(720px,95vw);background:var(--card);padding:32px;border-radius:16px;box-shadow:0 15px 40px rgba(0,0,0,.18)}
    h1{margin:0 0 8px;font-size:1.6rem;font-weight:800}
    p.helper{margin:0 0 30px;color:var(--muted);font-size:.9rem}
    .input-field{margin-bottom:30px}
    .input-field label{color:var(--fg);font-weight:600}
    .input-field input:focus+label{color:var(--accent)!important}
    .input-field input:focus{border-bottom:2px solid var(--accent)!important;box-shadow:0 2px 0 0 var(--accent)!important}
    .input-field input{min-height:48px}

    .btn-action-small{height:42px;line-height:42px;padding:0 18px;font-size:14px}
    .btn,.btn-large{background-color:var(--accent)!important;border-radius:8px;font-weight:700}
    .btn:hover{background-color:#1f52c6!important}
    .secondary-action{background-color:#e0e0e0!important;color:var(--fg)!important;border-radius:8px;font-weight:600}
    .secondary-action:hover{background-color:#cccccc!important}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}

    .result{margin-top:30px;padding:20px;border-radius:12px;background:var(--accent);color:#fff;box-shadow:0 6px 20px rgba(37,99,235,.6)}
    .result strong{font-size:1.5rem;color:#fff;font-weight:800}
    .result small{color:rgba(255,255,255,.8)}

    .countdown{margin-top:10px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--fg)}
    .error{margin-top:10px;color:#d32f2f;font-weight:700}

    .examples{margin-top:25px;font-size:.85rem;color:var(--muted)}
    code.kbd{padding:2px 5px;background:#e5e7eb;border-radius:4px;font-weight:600}

    @media (max-width:600px){
      body{display:block;padding:10px;height:auto}
      .app{width:100%;margin:0 auto;padding:18px 16px;border-radius:10px;box-shadow:none}
      .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px}
      .actions a{width:100%}
      h1{font-size:1.6rem;margin-bottom:5px}
      p.helper{margin-bottom:15px}
      .result strong{font-size:1.4rem}
      .result{margin-top:20px;padding:16px}
      .input-field{margin-bottom:20px}
      .btn-action-small{height:48px;line-height:48px;font-size:14px}
    }
  </style>
</head>
<body>
  <div class="app z-depth-1">
    <h1>Time Adder (AM/PM)</h1>
    <p class="helper">Select a start time and duration to calculate the end time.</p>

    <div class="row">
      <div class="col s12 m6">
        <div class="input-field">
          <input id="start" type="text" class="timepicker validate" placeholder="8:30 AM" required>
          <label for="start">Start Time (AM/PM)</label>
        </div>
      </div>
      <div class="col s12 m6">
        <div class="input-field">
          <input id="offset" type="text" class="validate" inputmode="decimal" value="8.5" required>
          <label for="offset">Add this many hours</label>
          <span class="helper-text">Use decimals (e.g., 1.25 for 1h 15m) or HH:MM (e.g., 1:15).</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <a id="calc" class="waves-effect waves-light btn">Calculate</a>
      <a id="now" class="waves-effect waves-light btn-flat secondary-action btn-action-small">Current Time</a>
      <a id="copy" class="waves-effect waves-light btn-flat secondary-action btn-action-small">Copy Result</a>
      <a id="clear" class="waves-effect waves-light btn-flat secondary-action btn-action-small">Clear</a>
    </div>

    <div id="error" class="error" role="alert" hidden></div>

    <div id="result" class="result" aria-live="polite">
      <small>Result will appear here</small>
    </div>
    <div id="countdown" class="countdown" aria-live="polite"></div>

    <div class="examples">
      Input examples: Start Time: <code class="kbd">7:00 PM</code>, Duration: <code class="kbd">8.5</code> or <code class="kbd">1:45</code>.
    </div>
  </div>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const startEl = $('#start');
    const offsetEl = $('#offset');
    const resultEl = $('#result');
    const errorEl = $('#error');
    const countdownEl = $('#countdown');

    let timePickerInstance;
    let timerId = null;

    // --- Persist inputs between app opens ---
    const LS = { start: 'ta.start', offset: 'ta.offset' };
    function saveState() {
      try {
        localStorage.setItem(LS.start, (startEl.value || '').trim());
        localStorage.setItem(LS.offset, (offsetEl.value || '').trim());
      } catch {}
    }
    function loadState() {
      try {
        return {
          start: localStorage.getItem(LS.start) || '',
          offset: localStorage.getItem(LS.offset) || ''
        };
      } catch { return { start: '', offset: '' }; }
    }
    function clearState() {
      try {
        localStorage.removeItem(LS.start);
        localStorage.removeItem(LS.offset);
      } catch {}
    }

    function showError(msg) {
      errorEl.textContent = msg;
      errorEl.hidden = !msg;
      if (msg) { resultEl.innerHTML = '<small>Result will appear here</small>'; clearCountdown(); }
    }

    // Fallback clipboard (works in strict WebViews)
    function copyToClipboard(text) {
      const temp = document.createElement('textarea');
      temp.value = text; document.body.appendChild(temp);
      temp.select(); document.execCommand('copy');
      document.body.removeChild(temp);
    }

    // Parse "8:30 AM" / "7 PM"
    function parseTime12(str) {
      if (!str) return NaN;
      const s = String(str).trim().replace(/\s+/g, ' ');
      const m = s.match(/^([0-9]{1,2})(?::([0-9]{1,2}))?\s*([AaPp])[Mm]?$/);
      if (!m) return NaN;
      let hh = Number(m[1]);
      let mm = m[2] ? Number(m[2]) : 0;
      const ap = m[3].toUpperCase();
      if (mm < 0 || mm > 59 || hh < 1 || hh > 12) return NaN;
      if (ap === 'A') { if (hh === 12) hh = 0; } else { if (hh !== 12) hh += 12; }
      return hh * 60 + mm;
    }

    // Parse decimal hours or HH:MM (supports +/-)
    function parseDuration(str) {
      if (!str) return NaN;
      const s = String(str).trim();
      if (/^[-+]?\d{1,3}:\d{1,2}$/.test(s)) {
        const sign = s.startsWith('-') ? -1 : 1;
        const [hPart, mPart] = s.replace(/^[-+]/, '').split(':');
        const h = Number(hPart), m = Number(mPart);
        if (Number.isNaN(h) || Number.isNaN(m) || m < 0 || m > 59) return NaN;
        return sign * (h * 60 + m);
      }
      const v = Number(s);
      if (Number.isNaN(v)) return NaN;
      return Math.round(v * 60);
    }

    function formatTime12(totalMinutes) {
      const MIN = 1440;
      let dayOffset = Math.floor(totalMinutes / MIN);
      let mins = ((totalMinutes % MIN) + MIN) % MIN;
      let hh24 = Math.floor(mins / 60);
      let mm = mins % 60;
      const ampm = hh24 >= 12 ? 'PM' : 'AM';
      let hh12 = hh24 % 12; if (hh12 === 0) hh12 = 12;
      const timeStr = `${hh12}:${String(mm).padStart(2, '0')} ${ampm}`;
      if (dayOffset !== 0) {
        const sign = dayOffset > 0 ? '+' : '\u2212';
        const daysAbs = Math.abs(dayOffset);
        return `${timeStr} (${sign}${daysAbs} day${daysAbs > 1 ? 's' : ''})`;
      }
      return timeStr;
    }

    // Countdown
    function computeTargetDate(totalMinutes) {
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0);
      return new Date(base.getTime() + totalMinutes * 60000);
    }
    function formatDiff(ms) {
      let sec = Math.floor(Math.abs(ms) / 1000);
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600); sec %= 3600;
      const m = Math.floor(sec / 60); const s = sec % 60;
      const hh = String(h).padStart(2,'0');
      const mm = String(m).padStart(2,'0');
      const ss = String(s).padStart(2,'0');
      return d ? `${d}d ${hh}:${mm}:${ss}` : `${hh}:${mm}:${ss}`;
    }
    function clearCountdown() {
      if (timerId) { clearInterval(timerId); timerId = null; }
      countdownEl.textContent = '';
    }
    function startCountdown(target) {
      clearCountdown();
      function tick() {
        const diff = target - new Date();
        const label = diff >= 0 ? 'Remaining: ' : 'Overdue by: ';
        countdownEl.textContent = label + formatDiff(diff);
      }
      tick();
      timerId = setInterval(tick, 1000);
    }

    function compute() {
      showError('');
      saveState();
      const start = parseTime12(startEl.value);
      const delta = parseDuration(offsetEl.value);
      if (Number.isNaN(start)) { showError('Please enter a valid start time (e.g., 8:30 AM).'); return; }
      if (Number.isNaN(delta)) { showError('Please enter a valid duration (e.g., 8.5 or 1:30).'); return; }
      const total = start + delta; // no +1 minute
      resultEl.innerHTML = `<strong>${formatTime12(total)}</strong>`;
      startCountdown(computeTargetDate(total));
    }

    // ===== Init: restore → init picker → wire events → first compute
    document.addEventListener('DOMContentLoaded', function() {
      // 1) Restore saved values first
      const saved = loadState();
      startEl.value = saved.start || startEl.placeholder;
      if (saved.offset) offsetEl.value = saved.offset;
      if (M && M.updateTextFields) M.updateTextFields();

      // 2) Initialize Materialize timepicker AFTER restore
      timePickerInstance = M.Timepicker.init(startEl, {
        twelveHour: true,
        autoClose: true,
        onSelect: (hours, minutes) => {
          const ap = hours >= 12 ? 'PM' : 'AM';
          let h12 = hours % 12; if (h12 === 0) h12 = 12;
          const timeStr = `${h12}:${String(minutes).padStart(2,'0')} ${ap}`;
          startEl.value = timeStr;
          if (M && M.updateTextFields) M.updateTextFields();
          saveState();
        },
        onCloseEnd: () => { saveState(); compute(); }
      });

      // 3) Wire buttons
      $('#calc').addEventListener('click', compute);
      $('#clear').addEventListener('click', () => {
        startEl.value = '';
        if (timePickerInstance) timePickerInstance.time = null;
        offsetEl.value = '8.5';
        resultEl.innerHTML = '<small>Result will appear here</small>';
        showError(''); clearCountdown(); clearState(); startEl.focus();
        if (M && M.updateTextFields) M.updateTextFields();
      });
      $('#now').addEventListener('click', () => {
        const now = new Date();
        let h = now.getHours(), m = now.getMinutes();
        const ap = h >= 12 ? 'PM' : 'AM';
        let h12 = h % 12; if (h12 === 0) h12 = 12;
        const timeStr = `${h12}:${String(m).padStart(2,'0')} ${ap}`;
        startEl.value = timeStr;
        if (timePickerInstance) timePickerInstance.time = timeStr;
        saveState();
        compute();
      });
      $('#copy').addEventListener('click', () => {
        const txt = resultEl.textContent.trim();
        if (!txt || txt === 'Result will appear here') { showError('Nothing to copy. Calculate first.'); return; }
        copyToClipboard(txt);
        resultEl.innerHTML = `<strong>${txt}</strong><span class="black-text" style="font-size:.9em;margin-left:8px;">Copied!</span>`;
        showError('');
      });

      // 4) Auto-save reliably (even without pressing Calculate)
      let t;
      offsetEl.addEventListener('input', () => { clearTimeout(t); saveState(); t = setTimeout(compute, 250); });
      offsetEl.addEventListener('change', saveState);
      startEl.addEventListener('input', saveState);
      startEl.addEventListener('change', saveState);
      startEl.addEventListener('blur', saveState);
      document.addEventListener('visibilitychange', () => { if (document.hidden) saveState(); });
      window.addEventListener('pagehide', saveState);

      // 5) First compute
      compute();
    });

    // PWA: register SW — bumped URL so browser fetches the new file
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js?v=3', { scope: './' })
          .catch(err => console.warn('SW register failed:', err));
      });
    }
  </script>
</body>
</html>
